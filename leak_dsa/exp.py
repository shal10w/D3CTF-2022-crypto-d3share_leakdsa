from sage.all import *
from random import *
from Crypto.Util.number import *
from hashlib import *
from binascii import *
def getdata(mask):
    a = []
    X = []
    mask = ('1' +bin(mask)[2:].rjust(256 ,'0'))[::-1]
    cnt = 0
    for i in range(len(mask)):
        if mask[i] == '0':
            if cnt == 0:
                a.append(2**i)
            cnt += 1
        else:
            if cnt != 0:
                X.append(2**cnt)
                cnt = 0

    return a , X

def to_hnp(mask , leakk , pubkey , c , m):
    p ,q,g,y = pubkey

    a, X = getdata(mask)
    M = Matrix(ZZ , len(a)+1 , len(a))
    for i in range(len(a)):
        M[i , i] = X[i]*q
        M[len(a) , i] = X[i]*a[i]
    B = M.BKZ(block_size = 20)
    res = B[1]
    print(res)
    print([abs(i) for i in res])
    print([len(bin(i)) for i in res])
    print(len(bin(sum([abs(i) for i in res]))[2:]))
    magic = (res[0] // X[0]) *inverse(a[0] , q) % q
    print(magic)
    r , s = c

    b = (m * inverse(s , q) - leakk)*magic % q
    a = r*inverse(s,q) * magic%q
    return a , b


def hnp(a , b , q):
    M = Matrix(ZZ , len(a) + 2 , len(a)+1)
    for i in range(len(a)):
        M[i , i] = q
        M[len(a) , i] = a[i]
        M[len(a)+1 , i] = b[i]
    M[len(a)+1 , len(a)] = 2**249
    
    temp = M.BKZ(block_size = 22)[1]
    print(temp)
    print([len(bin(i)[2:]) for i in temp])
    d = (temp[0] - b[0])*inverse(a[0] , q)%q
    print(d)
    
    print('d3ctf{' + sha256(str(d).encode()).hexdigest() + '}')
def sign(prikey , m):
    p,q,g,y,d = prikey
    k = randint(1 , q-1)
    r = pow(g , k , p) % q
    s = inverse(k , q) * (int(sha256(m).hexdigest(),16)+ d * r) % q
    return (r , s) , k

f = open('./leak_dsa/leak_dsa/cipher.txt' , 'r')

def readfile(line):
    line = line.split(',')
    m = int(sha256(unhexlify(line[0])).hexdigest() , 16)
    r = int(line[1][1:])
    s = int(line[2][1:-1])
    leakk = int(line[3])
    mask = int(line[4][:-1])
    
    return m ,r,s,leakk, mask

pubkey = (26673416629087098026916560506338277040549010554772843934729610035643733231250251102423182974044611233954642340959958834271335750920200897945439862639492196813221935010854523280944421271779323130471241396919277552656706801890216553068090994679167861167711115768531408637807760980399030014227820355188784957358710423286186701642225032815659071887663643416672470991428435579700861996670795174819086101750802301387224940484536624828758061993290084199627148932992832517695135987421150383092347766063005881995274573413740121394869480281904862144121358321887490931554938328148656564979653558079819177553267062168998915473681, 110391237652309415419047083882810095539100773703728353816796491823410719550161, 2755356762378504971752056629400618480248193308119517586256358804509732821795637172546750026615028140114060585669273290817072174412328914022306026911148568253211001503697582823781934600598488444260839987126340954045774504651510303030319213370411847368798562231499047901536032154390365265487834206849420245668448331817642357321195532669396326735815281220822230680557922201681988030251365724649482777396677154104834964687691146600524622872540791060796227867612102394936562024712761587047782531447109901970826231717088400311480532933238420501932808647646020376429899864282034643388717637211042626644309858816089594210873, 18217813593337268503433873383551588623937998597068864488275930377752269931251227554848720370092501607477878345351208836839915436048336523584683953147294223708669150899169925708166666175908817280402999482225317218652882865855773825840325465314966511478112193036871643888109904444715059158438654545047289810665366646044270016373299533103445401373739054240846321252224307032858256268287630890155618304871775878636658045197704916148773931319383377278339110061404683029233166869882071425794181205071954048313678202409088560608308448148959426071341691013885562941900417495363080234099189380677397880225216532014610872707780)
p ,q , g, y = pubkey

lines = f.readlines()[1:]
a = []
b = []
for i in range(70):
    m , r , s , leakk , mask = readfile(lines[i])
    tempa,tempb = to_hnp(mask , leakk , pubkey , (r,s) , m)
    a.append(tempa)
    b.append(tempb)


hnp(a , b , q)